#!/usr/bin/env python3
import argparse
import subprocess
import venv
from pathlib import Path

_DIR = Path(__file__).parent
_PROGRAM_DIR = _DIR.parent
_VENV_DIR = _PROGRAM_DIR / ".venv"


def run(cmd: list[str]) -> None:
    subprocess.check_call(cmd)


parser = argparse.ArgumentParser()
parser.add_argument("--dev", action="store_true", help="Install dev requirements (extras: dev)")
parser.add_argument("--tray", action="store_true", help="Install tray client requirements (extras: tray)")
args = parser.parse_args()

# Create virtual environment
builder = venv.EnvBuilder(with_pip=True)
context = builder.ensure_directories(_VENV_DIR)
builder.create(_VENV_DIR)

# Upgrade pip and setuptools
pip = [context.env_exe, "-m", "pip"]
run(pip + ["install", "--upgrade", "pip", "setuptools", "wheel"])

# Additive extras
extras: list[str] = []
if args.dev:
    extras.append("dev")
if args.tray:
    extras.append("tray")

# Install project + optional extras
if extras:
    extras_str = ",".join(extras)
    run(pip + ["install", "-e", f"{_PROGRAM_DIR}[{extras_str}]"])
else:
    run(pip + ["install", "-e", str(_PROGRAM_DIR)])
